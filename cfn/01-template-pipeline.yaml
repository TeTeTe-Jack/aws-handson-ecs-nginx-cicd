AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Pipeline Stack: Creates an ECR repository, a CodeBuild project to build and push
  Docker images from GitHub via CodeStar Connections, and a CodePipeline that triggers Create Docker image.

Parameters:
  SystemName:
    Type: String
    Default: demo
    Description: Logical name prefix
  Environment:
    Type: String
    Default: prod
    AllowedValues: [dev, stg, prod]
    Description: Environment name

  # GitHub (CodeStar Connections)
  GitHubConnectionArn:
    Type: String
    Description: CodeStar Connections ARN for GitHub
  GitHubFullRepositoryId:
    Type: String
    Description: GitHub owner/repository (e.g., your-org/your-repo)
  GitHubBranch:
    Type: String
    Default: main
    Description: Default branch (for manual runs; pass SourceVersion=refs/tags/* when deploying a tag)

  # CodeBuild environment
  BuildComputeType:
    Type: String
    Default: BUILD_GENERAL1_SMALL
    AllowedValues: [BUILD_GENERAL1_SMALL, BUILD_GENERAL1_MEDIUM, BUILD_GENERAL1_LARGE]
    Description: CodeBuild compute type
  BuildImage:
    Type: String
    Default: aws/codebuild/amazonlinux-x86_64-standard:5.0
    Description: CodeBuild runtime image

  # ECR
  EcrRepoName:
    Type: String
    Default: demo-nginx-html
    Description: ECR repository name

  # Artifact bucket (optional)
  ArtifactBucketName:
    Type: String
    Default: ''
    Description: Existing artifact bucket name. Leave blank to create one in this stack.

Conditions:
  CreateArtifactBucket: !Equals [!Ref ArtifactBucketName, ""]

Resources:
  EcrRepo:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Ref EcrRepoName
      ImageScanningConfiguration: { ScanOnPush: true }
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [
              {
                "rulePriority": 1,
                "description": "keep last 3 images",
                "selection": {
                  "tagStatus": "any",
                  "countType": "imageCountMoreThan",
                  "countNumber": 3
                },
                "action": { "type": "expire" }
              }
            ]
          }

  ArtifactBucket:
    Type: AWS::S3::Bucket
    Condition: CreateArtifactBucket
    Properties:
      BucketName: !If
        - CreateArtifactBucket
        - !Sub '${SystemName}-${Environment}-${AWS::AccountId}-${AWS::Region}-artifacts'
        - !Ref ArtifactBucketName
      VersioningConfiguration: { Status: Enabled }
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault: { SSEAlgorithm: AES256 }

  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${SystemName}-${Environment}-codebuild-role'
      Description: CodeBuild service role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: codebuild.amazonaws.com }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: BuildPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: [logs:CreateLogGroup, logs:CreateLogStream, logs:PutLogEvents]
                Resource: '*'
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:CompleteLayerUpload
                  - ecr:UploadLayerPart
                  - ecr:InitiateLayerUpload
                  - ecr:PutImage
                  - ecr:BatchGetImage
                Resource: '*'
              - Effect: Allow
                Action: [s3:PutObject, s3:GetObject, s3:GetObjectVersion, s3:ListBucket]
                Resource: '*'
              - Effect: Allow
                Action: [ssm:GetParameter*, secretsmanager:GetSecretValue]
                Resource: '*'

  BuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${SystemName}-${Environment}-build'
      Description: Builds Angular app, builds/pushes Docker image to ECR, and emits appspec/taskdef artifacts
      ServiceRole: !GetAtt CodeBuildRole.Arn
      Artifacts: { Type: CODEPIPELINE }
      Environment:
        ComputeType: !Ref BuildComputeType
        Image: !Ref BuildImage
        Type: LINUX_CONTAINER
        PrivilegedMode: true
        EnvironmentVariables:
          - Name: ECR_REPO
            Value: !Ref EcrRepoName
      Source:
        Type: CODEPIPELINE
      Cache:
        Type: LOCAL
        Modes: [LOCAL_SOURCE_CACHE, LOCAL_DOCKER_LAYER_CACHE]

  PipelineRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${SystemName}-${Environment}-codepipeline-role'
      Description: CodePipeline service role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: codepipeline.amazonaws.com }
            Action: sts:AssumeRole
      Policies:
        - PolicyName: PipelinePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: [s3:PutObject, s3:GetObject, s3:GetObjectVersion, s3:ListBucket]
                Resource: '*'
              - Effect: Allow
                Action: [codebuild:StartBuild, codebuild:BatchGetBuilds]
                Resource: '*'
              - Effect: Allow
                Action: [codestar-connections:UseConnection]
                Resource: [!Ref GitHubConnectionArn]

  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub '${SystemName}-${Environment}-pipeline'
      RoleArn: !GetAtt PipelineRole.Arn
      ArtifactStore:
        Type: S3
        Location: !If [CreateArtifactBucket, !Ref ArtifactBucket, !Ref ArtifactBucketName]
      RestartExecutionOnUpdate: true
      Stages:
        - Name: Source
          Actions:
            - Name: GitHub
              ActionTypeId: { Category: Source, Owner: AWS, Provider: CodeStarSourceConnection, Version: '1' }
              Configuration:
                ConnectionArn: !Ref GitHubConnectionArn
                FullRepositoryId: !Ref GitHubFullRepositoryId
                BranchName: !Ref GitHubBranch
                OutputArtifactFormat: CODE_ZIP
                DetectChanges: false
              OutputArtifacts: [{ Name: SourceOut }]
        - Name: Build
          Actions:
            - Name: DockerBuildPush
              ActionTypeId: { Category: Build, Owner: AWS, Provider: CodeBuild, Version: '1' }
              Configuration:
                ProjectName: !Ref BuildProject
              InputArtifacts: [{ Name: SourceOut }]
              OutputArtifacts: [{ Name: BuildOut }]

Outputs:
  EcrRepositoryUri:
    Value: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${EcrRepoName}'
    Description: ECR repository URI
  PipelineName:
    Value: !Ref Pipeline
    Description: CodePipeline name
  ArtifactBucketActual:
    Value: !If [CreateArtifactBucket, !Ref ArtifactBucket, !Ref ArtifactBucketName]
    Description: Name of the artifact bucket in use
