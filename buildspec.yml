version: 0.2

env:
  shell: bash

phases:
  install:
    commands:
      - |
        echo "==> Install nvm & Node.js 22"
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
        nvm install 22
        nvm alias default 22
        nvm use 22
        node -v && npm -v

  pre_build:
    commands:
      - echo "==> Resolve account & region"
      - ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

      # ---- Validate required envs (YAML-friendly) ----
      - '[ -n "${AWS_DEFAULT_REGION}" ] || { echo "ERROR: AWS_DEFAULT_REGION must be set by CodeBuild"; exit 1; }'
      - '[ -n "${ECR_REPO}" ] || { echo "ERROR: ECR_REPO must be set"; exit 1; }'

      # ---- Set defaults (no YAML parsing issues) ----
      - CONTAINER_NAME="${CONTAINER_NAME:-app}"
      - CONTAINER_PORT="${CONTAINER_PORT:-80}"
      - SYSTEM_NAME="${SYSTEM_NAME:-demo}"
      - ENVIRONMENT="${ENVIRONMENT:-prod}"
      - TASK_CPU="${TASK_CPU:-256}"
      - TASK_MEMORY="${TASK_MEMORY:-512}"

      - IMAGE_REPO="${ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${ECR_REPO}"
      - IMAGE_TAG="${CODEBUILD_RESOLVED_SOURCE_VERSION:0:7}"
      - IMAGE_URI="${IMAGE_REPO}:${IMAGE_TAG}"
      - echo "ECR_REPO=${ECR_REPO}, IMAGE_URI=${IMAGE_URI}"

      - echo "==> Login to ECR"
      - aws ecr get-login-password | docker login --username AWS --password-stdin "${ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"

  build:
    commands:
      - echo "==> Build Angular (adjust if needed)"
      - npm ci
      - npm run build

      - echo "==> Docker build & push"
      - docker build -t "${IMAGE_URI}" -t "${IMAGE_REPO}:latest" .
      - docker push "${IMAGE_URI}"
      - docker push "${IMAGE_REPO}:latest"

artifacts:
  files:
    - taskdef.json
    - appspec.yaml
    - '**/*'
  discard-paths: no
